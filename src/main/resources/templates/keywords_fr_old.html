<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{wide_fr}" lang="fr">

<th:block layout:fragment="content">
	<div class="row">
		<div class="col-md-12">
			<h1>Gestion des mots-clés</h1>
			<p>Gérer les mots-clés de filtrage de contenu, y compris les mots vulgaires, les menaces, les mots autorisés et les mots-clés d'erreur.</p>
			
			<!-- Boutons d'action -->
			<div class="btn-toolbar" style="margin-bottom: 20px;">
				<button id="addNewBtn" class="btn btn-primary">Ajouter un nouveau mot</button>
				<button id="exportBtn" class="btn btn-default">Exporter en CSV</button>
				<label for="importFile" class="btn btn-default" style="margin-bottom: 0;">
					Importer depuis CSV
					<input type="file" id="importFile" accept=".csv" style="display: none;">
				</label>
			</div>
			
			<!-- Modal d'ajout/modification -->
			<div id="editModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
				<div style="background-color: white; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 5px;">
					<h2 id="modalTitle">Ajouter un nouveau mot</h2>
					<form id="editForm">
						<input type="hidden" id="editId" value="">
						
						<div class="form-group">
							<label for="editWord">Mot :</label>
							<input type="text" class="form-control" id="editWord" required>
						</div>
						
						<div class="form-group">
							<label for="editLanguage">Langue :</label>
							<select class="form-control" id="editLanguage" required>
								<option value="en">Anglais (en)</option>
								<option value="fr">Français (fr)</option>
								<option value="both">Les deux (both)</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="editType">Type :</label>
							<select class="form-control" id="editType" required>
								<option value="profanity">Vulgaire</option>
								<option value="threat">Menace</option>
								<option value="allowed">Autorisé</option>
								<option value="error">Erreur</option>
							</select>
						</div>
						
						<div class="form-group">
							<label>
								<input type="checkbox" id="editActive" checked> Actif
							</label>
						</div>
						
						<div id="errorMessage" style="color: red; margin-bottom: 10px; display: none;"></div>
						
						<div class="btn-group">
							<button type="submit" class="btn btn-primary">Enregistrer</button>
							<button type="button" id="cancelBtn" class="btn btn-default">Annuler</button>
						</div>
					</form>
				</div>
			</div>
			
			<!-- Tableau des mots interdits -->
			<table class="wb-tables table table-striped">
				<thead>
					<tr>
						<th>Mot</th>
						<th>Langue</th>
						<th>Type</th>
						<th>Statut</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					<tr th:remove="tag" th:utext="${data}"></tr>
				</tbody>
			</table>
		</div>
	</div>
</th:block>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		$(document).on("wb-ready.wb", function () {
			
			// Bouton ajouter un nouveau mot
			$("#addNewBtn").on("click", function () {
				$("#modalTitle").text("Ajouter un nouveau mot");
				$("#editId").val("");
				$("#editWord").val("");
				$("#editLanguage").val("fr");
				$("#editType").val("profanity");
				$("#editActive").prop("checked", true);
				$("#errorMessage").hide();
				$("#editModal").show();
			});
			
			// Bouton annuler
			$("#cancelBtn").on("click", function () {
				$("#editModal").hide();
			});
			
			// Fermer le modal en cliquant à l'extérieur
			$("#editModal").on("click", function (e) {
				if (e.target.id === "editModal") {
					$("#editModal").hide();
				}
			});
			
			// Bouton modifier
			$("body").on("click", ".editBtn", function (e) {
				var btn = $(e.target);
				$("#modalTitle").text("Modifier le mot");
				$("#editId").val(btn.data("id"));
				$("#editWord").val(btn.data("word"));
				$("#editLanguage").val(btn.data("language"));
				$("#editType").val(btn.data("type"));
				$("#editActive").prop("checked", btn.data("active"));
				$("#errorMessage").hide();
				$("#editModal").show();
			});
			
			// Soumission du formulaire
			$("#editForm").on("submit", function (e) {
				e.preventDefault();
				
				var id = $("#editId").val();
				var url = id ? "/keywords/update" : "/keywords/create";
				var data = {
					word: $("#editWord").val(),
					language: $("#editLanguage").val(),
					type: $("#editType").val(),
					active: $("#editActive").is(":checked")
				};
				
				if (id) {
					data.id = id;
				}
				
				$.ajax({
					type: "get",
					data: data,
					cache: false,
					url: url,
					dataType: "text",
					error: function (xhr, status, error) {
						$("#errorMessage").text("Erreur : " + xhr.responseText).show();
					},
					success: function (response) {
						if (response.startsWith("Error")) {
							$("#errorMessage").text(response).show();
						} else {
							$("#editModal").hide();
							location.reload();
						}
					}
				});
			});
			
			// Bouton supprimer
			$("body").on("click", ".deleteBtn", function (e) {
				if (!confirm("Êtes-vous sûr de vouloir supprimer ce mot ?")) {
					return;
				}
				
				var id = $(e.target).attr("id").replace("delete", "");
				$.ajax({
					type: "get",
					data: { "id": id },
					cache: false,
					url: "/keywords/delete",
					dataType: "text",
					error: function (xhr, status, error) {
						alert("Erreur : " + xhr.responseText);
					},
					success: function (response) {
						if (response.startsWith("Error")) {
							alert(response);
						} else {
							$(e.target).closest("tr").remove();
						}
					}
				});
			});
			
			// Bouton activer
			$("body").on("click", ".activateBtn", function (e) {
				var id = $(e.target).attr("id").replace("activate", "");
				$.ajax({
					type: "get",
					data: {
						"id": id,
						"active": true
					},
					cache: false,
					url: "/keywords/update",
					dataType: "text",
					error: function (xhr, status, error) {
						alert("Erreur : " + xhr.responseText);
					},
					success: function (response) {
						if (response.startsWith("Error")) {
							alert(response);
						} else {
							var row = $("#activate" + id).closest("tr");
							row.find("td:eq(3)").text("Actif");
							$("#activate" + id).replaceWith("<button id='deactivate" + id
								+ "' class='btn btn-xs deactivateBtn'>Désactiver</button>");
						}
					}
				});
			});
			
			// Bouton désactiver
			$("body").on("click", ".deactivateBtn", function (e) {
				var id = $(e.target).attr("id").replace("deactivate", "");
				$.ajax({
					type: "get",
					data: {
						"id": id,
						"active": false
					},
					cache: false,
					url: "/keywords/update",
					dataType: "text",
					error: function (xhr, status, error) {
						alert("Erreur : " + xhr.responseText);
					},
					success: function (response) {
						if (response.startsWith("Error")) {
							alert(response);
						} else {
							var row = $("#deactivate" + id).closest("tr");
							row.find("td:eq(3)").text("Inactif");
							$("#deactivate" + id).replaceWith("<button id='activate" + id
								+ "' class='btn btn-xs activateBtn'>Activer</button>");
						}
					}
				});
			});
			
			// Bouton exporter
			$("#exportBtn").on("click", function () {
				window.location.href = "/keywords/export";
			});
			
			// Importer un fichier
			$("#importFile").on("change", function (e) {
				var file = e.target.files[0];
				if (!file) {
					return;
				}
				
				var formData = new FormData();
				formData.append("file", file);
				
				$.ajax({
					type: "POST",
					url: "/keywords/import",
					data: formData,
					processData: false,
					contentType: false,
					success: function (response) {
						alert(response);
						location.reload();
					},
					error: function (xhr, status, error) {
						alert("Erreur lors de l'importation du fichier : " + xhr.responseText);
					}
				});
				
				// Réinitialiser l'input fichier
				$(e.target).val("");
			});
		});
	</script>
</th:block>

</html>
