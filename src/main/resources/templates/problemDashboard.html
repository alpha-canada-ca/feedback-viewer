<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{wide}" lang="en">

<th:block layout:fragment="content">
	<div class="row"></div>
		<div class="col-md-4">
			<h4 class="wb-inv">Filtering options</h4>
			<details open>
				<summary>
					<h4 class="h4">Filter options</h4>
				</summary>
				<p class="mrgn-tp-md">Use filters to change your results in the
					data table</p>
				<form class="wb-tables-filter" data-bind-to="problemTable">
					<div class="form-group">
						<label for="Institution">Institution</label> <select
							class="form-control" id="Institution" name="Institution" data-column="0">
							<option value="">All</option>
							<option value="DTO">Digital Transformation Office</option>
							<option value="FIN">Department of Finance</option>
							<option value="Health Canada">Health Canada</option>
							<option value="Public Health Agency of Canada">Public Health Agency of Canada</option>
							<option value="CRA">Canada Revenue Agency</option>
							
							<!-- DEPARTMENTS -->
						</select>
					</div>

					<div class="form-group">
						<label for="dt_theme">Theme</label> <select class="form-control"
							id="dt_theme" name="dt_theme" data-column="2">
							<option value="">All</option>
							<option value="COVID">COVID</option>
							<option value="Taxes">Taxes</option>
							<option value="Health">Health</option>
							<option value="Travel">Travel</option>
							<!-- THEMES -->
						</select>
					</div>
					
					<div class="btn-group">
						<button type="submit" class="btn btn-primary"
							aria-controls="problemTable">Filter</button>
						<button type="reset" class="btn btn-primary">Reset to
							defaults</button>
					</div>
				</form>
			</details>
		</div>
		<div class="col-md-8">
			
				<table id="problemTable" class="table">
					<thead>
						<tr>
							<th>Institution</th>
							<th>Section</th>
							<th>Theme</th>
							<th>Language</th>
							<th>URL</th>
							<th>Problem</th>
							<th>Problem Details</th>
							<th>Date Entered</th>
							<th>Tags</th>
							<th>Resolution</th>
							<th>Resolution Date</th>
							<th>Action</th>
						</tr>
					</thead>
					<tbody>
						<tr th:remove="tag" th:utext="${data}"></tr>
					</tbody>
					
				</table>
			
		</div>
	</div>
	<section id="submitWindow"
		class="mfp-hide modal-dialog modal-content overlay-def">
		<header class="modal-header">
			<h1 class="modal-title">Resolution</h1>
		</header>
		<div class="modal-body">
			<div class="wb-frmvld">
				<form id="resolutionForm" name="resolutionForm" method="post">
					<div class="form-group">
						<label for="comments" class="control-label required">
							Notes: </label>
						<textarea id="notes" name="notes" class="form-control"
							required="required" rows="10" cols="47"></textarea>
					</div>
					<input type="submit" class="btn" name="submit" id="submit"
						value="Submit" />
				</form>
			</div>
		</div>
	</section>
	<section id="tagWindow"
		class="mfp-hide modal-dialog modal-content overlay-def">
		<header class="modal-header">
			<h1 class="modal-title">Tags</h1>
		</header>
		<div class="modal-body">
			<div class="wb-frmvld">
				<form id="tagsForm" name="tagsForm" method="post">
					<div class="form-group">
						<label for="tags" class="control-label required"> Tags: </label>
						<textarea id="tags" name="tags" class="form-control"
							required="required" rows="10" cols="47"></textarea>
					</div>
					<input type="submit" class="btn" name="submit" id="submit"
						value="Submit" />
				</form>
			</div>
		</div>
	</section>




</th:block>
<th:block layout:fragment="script">
	<script
	src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script
	src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
<script
	src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.flash.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script
	src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
<script
	src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.print.min.js"></script>
<script
	src="https://cdn.datatables.net/colreorder/1.5.2/js/dataTables.colReorder.min.js"></script>

	<script th:inline="javascript">

		$(document).ready(function() {
			$('#problemTable thead tr').clone(true).appendTo( '#problemTable thead' );
			$('#problemTable thead tr:eq(1) th').each( function (i) {
				var title = $(this).text();
				$(this).html( '<input type="text" placeholder="Search '+title+'" />' );
		
				$( 'input', this ).on( 'keyup change', function () {
					if ( table.column(i).search() !== this.value ) {
						table
							.column(i)
							.search( this.value )
							.draw();
					}
				} );
			} );
		
			var table = $('#problemTable').DataTable( {
				retrieve: true,
				orderCellsTop: true,
				fixedHeader: true,
				dom: 'fBr<"table-responsive"t>i',
				buttons : [{
					extend : 'csv',
					className : 'btn btn-default',
					},{
					extend : 'excel',
					className : 'btn btn-default'
				}]
			} );
		
			$('#problemTable').find( 'thead th' ).append( '<span class="sorting-cnt"><span class="sorting-icons"></span></span>')

		} );
		
		
		$(document).on("wb-ready.wb", function() {
			const columns = {
				DEPARTMENT : 0,
				SECTION : 1,
				THEME : 2,
				LANGUAGE : 3,
				URL : 4,
				PROBLEM : 5,
				PROBLEM_DETAILS : 6,
				PROBLEM_DATE : 7,
				TAGS : 8,
				RESOLUTION : 9,
				RESOLUTION_DATE : 10,
				ACTION : 11
			};

			// DataTable
			var table = $('#problemTable').DataTable( {
				retrieve:       true,
				scrollCollapse: true,
				paging:         false,
				fixedColumns:   true,
				colReorder:     true,
				scrollY:        "300px",
				scrollX:        true			
			}); 
			
			
			
			$("#problemTable").on("click",".resolveBtn", function(e) {
				var id = $(e.target).attr("id").replace("resolve","");
				var items = $("#resolve" + id).parent().parent().parent().find("td");
				$("#notes").val($(items.get(columns.RESOLUTION)).text());
				//alert($('#submitWindow').find('input#submit').length);
				$('#submitWindow').find('input#submit').off().on("click",function(e) {
					e.preventDefault();
					e.stopImmediatePropagation();
					var obj = {
						"department" : $(items.get(columns.DEPARMENT)).text(),
						"language" : $(items.get(columns.LANGUAGE)).text(),
						"url" : $(items.get(columns.URL)).text(),
						"problem" : $(items.get(columns.PROBLEM)).text(),
						"problemDetails" : $(items.get(columns.PROBLEM_DETAILS)).text(),
						"problemDate" : $(items.get(columns.PROBLEM_DATE)).text(),
						"resolution" : $("#notes").val(),
						"id" : id
					};
					$.ajax({
					    type:     "post",
					    data:     obj,
					    cache:    false,
					    url:      "updateProblem",
					    dataType: "text",
					    error: function (xhr,status, error) {
					    	console.log(xhr.responseText);
					    },
					    success: function (date) {
					    	$(items.get(columns.RESOLUTION)).text($("#notes").val());
					    	$("#notes").val("");
					    	$(items.get(columns.RESOLUTION_DATE)).text(date);
					    	$(".popup-modal-dismiss").click();
					    }
					});
					
				});
				wb.doc.trigger("open.wb-lbx", [ [ {
					src : "#submitWindow",
					type : "inline"
				} ] ]);

			});
			
			
			$("#problemTable").on("click",".deleteBtn", function(e) {
				var id = $(e.target).parent().attr("id").replace("delete","");
				$.ajax({
				    type:     "get",
				    data:     {"id" : id},
				    cache:    false,
				    url:      "deleteProblem",
				    dataType: "text",
				    error: function (xhr,status, error) {
				    	console.log(xhr.responseText);
				    },
				    success: function () {
				    	var tr = $(e.target).parent().parent().parent().parent();
				    //	var row = ($('#problemTable').DataTable().row($(tr))).remove();
				    //	row.remove();
				    //	$('#problemTable').DataTable().draw("full-hold");
				    }
				});
			});
			
			$("#problemTable").on("click",".tagBtn", function(e) {
				var id = $(e.target).attr("id").replace("tag","");
				var items = $("#tag" + id).parent().parent().parent().find("td");
				var tags = $(items.get(columns.TAGS)).text().replace(/\s*\(x\)\s*/g,",").replace(/.$/,"");
				$("#tags").val(tags);
				$('#tagWindow').find('input#submit').off().on("click",function(e) {
					e.preventDefault();
					e.stopImmediatePropagation();
					var obj = {
						"tags" : $("#tags").val(),
						"id" : id
					};
					$.ajax({
					    type:     "post",
					    data:     obj,
					    cache:    false,
					    url:      "updateTags",
					    dataType: "text",
					    error: function (xhr,status, error) {
					    	console.log(xhr.responseText);
					    },
					    success: function (tags) {
					    	$(items.get(columns.TAGS)).html(tags);
					    	$("#tags").val("");
					    	$(".popup-modal-dismiss").click();
					    }
					});
					
				});
				wb.doc.trigger("open.wb-lbx", [ [ {
					src : "#tagWindow",
					type : "inline"
				} ] ]);

			});
			
			$("#problemTable").on("click",".tagDeleteBtn", function(e) {
				var id = $(e.target).attr("id").replace("tagDelete","");
				var tag = $(e.target).text().replace(/\s*\(x\)\s*/g,"");
				var obj = {
					"tag" : tag,
					"id" : id
				};
				$.ajax({
				    type:     "post",
				    data:     obj,
				    cache:    false,
				    url:      "deleteTag",
				    dataType: "text",
				    error: function (xhr,status, error) {
				    	console.log(xhr.responseText);
				    },
				    success: function (tags) {
				    	$(e.target).remove();
				    }
				});
			});
		

		});
	</script>
</th:block>
</html>