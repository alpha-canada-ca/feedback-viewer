<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{wide}" lang="en">
<th:block layout:fragment="content">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <style>
        th {
            font-size: 12px;
        }
        
        td {
            font-size: 12px;
        }
        
        .table.dataTable {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: 12px;
        }
        
        .dataTables_filter input {
            height: 35px;
            width: 150px;
        }
        
        .dataTables_filter {
            font-size: 15px;
        }
        
        .dataTables_length {
            font-size: 12px;
        }
        
        .dataTables_info {
            font-size: 12px;
        }
        
        .dataTables_paginate {
            font-size: 12px;
        }
        
        .dt-button {
            text-align: center;
            font-size: 12px;
        }
    </style>

    <div class="container">
        <h4 class="wb-inv">Filtering options</h4>

        <form class="wb-tables-filter" data-bind-to="problemTable">
            <h4 class="h4">Filter options</h4>
            <p class="mrgn-tp-md">Use filters to change your results in the data table</p>
            <div class="row">
                <div class="form-group col-sm-5">
                    <label for="Institution">Institution</label>
                    <select class="form-control" id="Institution" name="Institution" data-column="6">
                                        <option value="">All</option>
                                        <option value="CRA">Canada Revenue Agency</option>
                                        <option value="DFO">Department of Fisheries and Oceans</option>
                                        <option value="Employment and Social Development Canada">Employment and Social Development Canada</option>
                                        <option value="FCAC">Financial Consumer Agency of Canada</option>
                                        <option value="FIN">Department of Finance</option>
                                        <option value="Health Canada">Health Canada</option>
                                        <option value="ISED">Innovation, Science and Economic Development Canada</option>
                                        <option value="NRC">National Research Council</option>
                                        <option value="Public Health Agency of Canada">Public Health Agency of Canada</option>
                                        <option value="PSPC">Public Services and Procurement Canada</option>
                                        <option value="TBS">Treasury Board of Canada Secretariat</option>
                                        <!-- DEPARTMENTS -->
                    </select>
                </div>

                <div class="form-group col-sm-2">
                    <label for="dt_theme">Theme</label> <select class="form-control" id="dt_theme" name="dt_theme" data-column="8">
                                        <option value="">All</option>
                                        <option value="Business">Business</option>
                                        <option value="COVID">COVID</option>
                                        <option value="Environment and natural resources">Environment and Natural Resources</option>
                                        <option value="Health">Health</option>
                                        <option value="Money and finances">Money and Finances</option>
                                        <option value="Public Service">Public Service</option>
                                        <option value="Science and innovation">Science and Innovation</option>
                                        <option value="Travel">Travel</option>
                                        <option value="Taxes">Taxes</option>
                                        <!-- THEMES -->
                                    </select>
                </div>

                <div class="col-sm-5">
                    <label for="min">Date Range <span class="wb-inv">from start date</span></label>
                    <div class="form-inline">
                        <div class="form-group">
                            <input type="date" class="form-control" id="min" name="min">
                        </div>
                        <label for="max">To <span class="wb-inv">end date</span></label>
                        <div class="form-group">
                            <input type="date" class="form-control" id="max" name="max">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mrgn-lft-sm row">
                <!-- <button type="submit" class="btn btn-primary" aria-controls="problemTable">Filter</button> -->
                <button type="reset" class="btn btn-primary" onclick="clearText()">Reset to defaults</button>
            </div>
            <br>
        </form>
    </div>

    <div class="col-md-12">
        <div class="table-responsive">
            <table id="problemTable" class="small table hover display compact">
                <thead>
                    <tr>

                        <th>Date</th>
                        <th>Comment</th>
                        <th>Problem</th>
                        <th>Tags</th>
                        <th>URL</th>
                        <th>Language</th>
                        <th>Institution</th>
                        <th>Section</th>
                        <th>Theme</th>

                    </tr>
                </thead>
                <tbody>
                    <!--<tr th:remove="tag" th:utext="${data}"></tr> -->
                </tbody>

            </table>
        </div>

    </div>
    </div>
    <section id="submitWindow" class="mfp-hide modal-dialog modal-content overlay-def">
        <header class="modal-header">
            <h1 class="modal-title">Resolution</h1>
        </header>
        <div class="modal-body">
            <div class="wb-frmvld">
                <form id="resolutionForm" name="resolutionForm" method="post">
                    <div class="form-group">
                        <label for="comments" class="control-label required">
							Notes: </label>
                        <textarea id="notes" name="notes" class="form-control" required="required" rows="10" cols="47"></textarea>
                    </div>
                    <input type="submit" class="btn" name="submit" id="submit" value="Submit" />
                </form>
            </div>
        </div>
    </section>
    <section id="tagWindow" class="mfp-hide modal-dialog modal-content overlay-def">
        <header class="modal-header">
            <h1 class="modal-title">Tags</h1>
        </header>
        <div class="modal-body">
            <div class="wb-frmvld">
                <form id="tagsForm" name="tagsForm" method="post">
                    <div class="form-group">
                        <label for="tags" class="control-label required"> Tags: </label>
                        <textarea id="tags" name="tags" class="form-control" required="required" rows="10" cols="47"></textarea>
                    </div>
                    <input type="submit" class="btn" name="submit" id="submit" value="Submit" />
                </form>
            </div>
        </div>
    </section>




</th:block>
<th:block layout:fragment="script">
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/colreorder/1.5.2/js/dataTables.colReorder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/busy-load@0.1.2/src/index.min.js"></script>

    <script type="text/javascript" src="js/spring-friendly.min.js"></script>

    <script type="text/javascript">
        function clearText() {
            $("#searchCol0").val("");
            $("#searchCol1").val("");
            $("#searchCol2").val("");
            $("#searchCol3").val("");
            $("#searchCol4").val("");
            $("#searchCol5").val("");
            $("#searchCol6").val("");
            $("#searchCol7").val("");
            $("#searchCol8").val("");
        }
    </script>
    <script th:inline="javascript">
        $(document).ready(function() {

            function sortSelectOptions(selector, skip_first) {
                var options = (skip_first) ? $(selector + ' option:not(:first)') : $(selector + ' option');
                var arr = options.map(function(_, o) {
                    return {
                        t: $(o).text(),
                        v: o.value,
                        s: $(o).prop('selected')
                    };
                }).get();
                arr.sort(function(o1, o2) {
                    var t1 = o1.t.toLowerCase(),
                        t2 = o2.t.toLowerCase();
                    return t1 > t2 ? 1 : t1 < t2 ? -1 : 0;
                });
                options.each(function(i, o) {
                    o.value = arr[i].v;
                    $(o).text(arr[i].t);
                    if (arr[i].s) {
                        $(o).attr('selected', 'selected').prop('selected', true);
                    } else {
                        $(o).removeAttr('selected');
                        $(o).prop('selected', false);
                    }
                });
            }
            sortSelectOptions('#Institution', true);
            sortSelectOptions('#dt_theme', true);


            function newexportaction(e, dt, button, config) {
                var self = this;
                var oldStart = dt.settings()[0]._iDisplayStart;
                dt.one('preXhr', function(e, s, data) {
                    // Just this once, load all data from the server...
                    data.start = 0;
                    data.length = 2147483647;
                    dt.one('preDraw', function(e, settings) {
                        // Call the original action function
                        if (button[0].className.indexOf('buttons-copy') >= 0) {
                            $.fn.dataTable.ext.buttons.copyHtml5.action.call(self, e, dt, button, config);
                        } else if (button[0].className.indexOf('buttons-excel') >= 0) {
                            $.fn.dataTable.ext.buttons.excelHtml5.available(dt, config) ?
                                $.fn.dataTable.ext.buttons.excelHtml5.action.call(self, e, dt, button, config) :
                                $.fn.dataTable.ext.buttons.excelFlash.action.call(self, e, dt, button, config);
                        } else if (button[0].className.indexOf('buttons-csv') >= 0) {
                            $.fn.dataTable.ext.buttons.csvHtml5.available(dt, config) ?
                                $.fn.dataTable.ext.buttons.csvHtml5.action.call(self, e, dt, button, config) :
                                $.fn.dataTable.ext.buttons.csvFlash.action.call(self, e, dt, button, config);
                        } else if (button[0].className.indexOf('buttons-pdf') >= 0) {
                            $.fn.dataTable.ext.buttons.pdfHtml5.available(dt, config) ?
                                $.fn.dataTable.ext.buttons.pdfHtml5.action.call(self, e, dt, button, config) :
                                $.fn.dataTable.ext.buttons.pdfFlash.action.call(self, e, dt, button, config);
                        } else if (button[0].className.indexOf('buttons-print') >= 0) {
                            $.fn.dataTable.ext.buttons.print.action(e, dt, button, config);
                        }
                        dt.one('preXhr', function(e, s, data) {
                            // DataTables thinks the first item displayed is index 0, but we're not drawing that.
                            // Set the property to what it was before exporting.
                            settings._iDisplayStart = oldStart;
                            data.start = oldStart;
                        });
                        // Reload the grid with the original page. Otherwise, API functions like table.cell(this) don't work properly.
                        setTimeout(dt.ajax.reload, 0);
                        // Prevent rendering of the full data to the DOM
                        return false;
                    });
                });
                // Requery the server with the new one-time export settings
                dt.ajax.reload();
            };

            $('#problemTable').find('thead th').append('<span class="sorting-cnt"><span class="sorting-icons"></span></span>')


            var table = $('table#problemTable').DataTable({
                "order": [
                    [0, "desc"]
                ],
                processing: true,
                ajax: {},
                "language": {
                    processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading..n.</span> '
                },

                "lengthMenu": [10, 25, 50],
                retrieve: true,
                'ajax': '/problemData',
                'serverSide': true,
                columns: [{
                    data: 'problemDate'
                }, {
                    data: 'problemDetails'
                }, {
                    data: 'problem'
                }, {
                    data: 'tags'
                }, {
                    data: 'url'
                }, {
                    data: 'language'
                }, {
                    data: 'institution'
                }, {
                    data: 'section'
                }, {
                    data: 'theme'
                }],

                orderCellsTop: true,
                fixedHeader: true,
                dom: 'fBr<"table-responsive"t>tipl',
                buttons: [{
                    "extend": 'csv',
                    "text": 'Download CSV',
                    className: 'btn btn-default',
                    "action": newexportaction,
                }, {
                    "extend": 'excel',
                    "text": "Download Excel",
                    className: 'btn btn-default',
                    "action": newexportaction,
                }]
            });

            function replaceSpecialChars(string) {
                var string = string.replace(/[.?]/g, '\\$&');
                return string;
            }

            $('#problemTable thead tr').clone(true).appendTo('#problemTable thead');
            $('#problemTable thead tr:eq(1) th').each(function(i) {
                var title = $(this).text();
                $(this).html('<input type="text" id="searchCol' + i + '" placeholder="Search ' + title + '" />');

                $('input', this)
                    .unbind()
                    .bind('keyup change', function(e) {
                        if (e.keyCode == 13 || this.value == "") {
                            table
                                .column(i)
                                .search(replaceSpecialChars(this.value))
                                .draw();
                        }
                    });

            });



            var flag = false;
            var flag2 = false;
            $('#min', this).on('keyup change', function() {
                if (this.value != "" && $('#max').val() != "") {
                    flag = true;
                    table
                        .column(0)
                        .search(this.value + ":" + $('#max').val())
                        .draw();
                }
                if ($('#dt_theme').val() != "" && flag) {
                    table
                        .column(8)
                        .search($('#dt_theme').val())
                        .draw()
                }
                if ($('#Institution').val() != "" && flag) {
                    table
                        .column(6)
                        .search($('#Institution').val())
                        .draw()
                }
            });

            $('#max', this).on('keyup change', function() {
                if (this.value != "" && $('#min').val() != "") {
                    flag2 = true;
                    table
                        .column(0)
                        .search($('#min').val() + ":" + this.value)
                        .draw();
                }
                if ($('#dt_theme').val() != "" && flag2) {
                    table
                        .column(8)
                        .search($('#dt_theme').val())
                        .draw()
                }
                if ($('#Institution').val() != "" && flag2) {
                    table
                        .column(6)
                        .search($('#Institution').val())
                        .draw()
                }
            });

            $('#dt_theme', this).on('keyup change', function() {
                if (this.value == "") {
                    table
                        .column(8)
                        .search("")
                        .draw()
                }
                if (this.value != "") {
                    table
                        .column(8)
                        .search(this.value)
                        .draw()
                }
                if (flag && flag2) {
                    table
                        .column(0)
                        .search($('#min').val() + ":" + $('#max').val())
                        .draw();
                }
                if ($('#Institution').val()) {
                    table
                        .column(6)
                        .search($('#Institution').val())
                        .draw()
                }
            });
            $('#Institution', this).on('keyup change', function() {
                if (this.value == "") {
                    table
                        .column(6)
                        .search("")
                        .draw()
                }
                if (this.value != "") {
                    table
                        .column(6)
                        .search(this.value)
                        .draw()
                }
                if (flag && flag2) {
                    table
                        .column(0)
                        .search($('#min').val() + ":" + $('#max').val())
                        .draw();
                }
                if ($('#dt_theme').val() != "") {
                    table
                        .column(8)
                        .search($('#dt_theme').val())
                        .draw()
                }
            });


            // $('#min').keyup(function() {
            //     table.fnDraw();
            // });
            // $('#max').keyup(function() {
            //     table.fnDraw();
            // });

        });

        $(document).on("wb-ready.wb", function() {



            $("#problemTable").on("click", ".resolveBtn", function(e) {
                var id = $(e.target).attr("id").replace("resolve", "");
                var items = $("#resolve" + id).parent().parent().parent().find("td");
                $("#notes").val($(items.get(columns.RESOLUTION)).text());
                //alert($('#submitWindow').find('input#submit').length);
                $('#submitWindow').find('input#submit').off().on("click", function(e) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    var obj = {
                        "department": $(items.get(columns.DEPARMENT)).text(),
                        "language": $(items.get(columns.LANGUAGE)).text(),
                        "url": $(items.get(columns.URL)).text(),
                        "problem": $(items.get(columns.PROBLEM)).text(),
                        "problemDetails": $(items.get(columns.PROBLEM_DETAILS)).text(),
                        "problemDate": $(items.get(columns.PROBLEM_DATE)).text(),
                        "resolution": $("#notes").val(),
                        "id": id
                    };
                    $.ajax({
                        type: "post",
                        data: obj,
                        cache: false,
                        url: "updateProblem",
                        dataType: "text",
                        error: function(xhr, status, error) {
                            console.log(xhr.responseText);
                        },
                        success: function(date) {
                            $(items.get(columns.RESOLUTION)).text($("#notes").val());
                            $("#notes").val("");
                            $(items.get(columns.RESOLUTION_DATE)).text(date);
                            $(".popup-modal-dismiss").click();
                        }
                    });

                });
                wb.doc.trigger("open.wb-lbx", [
                    [{
                        src: "#submitWindow",
                        type: "inline"
                    }]
                ]);

            });


            $("#problemTable").on("click", ".deleteBtn", function(e) {
                var id = $(e.target).parent().attr("id").replace("delete", "");
                $.ajax({
                    type: "get",
                    data: {
                        "id": id
                    },
                    cache: false,
                    url: "deleteProblem",
                    dataType: "text",
                    error: function(xhr, status, error) {
                        console.log(xhr.responseText);
                    },
                    success: function() {
                        var tr = $(e.target).parent().parent().parent().parent();
                        //	var row = ($('#problemTable').DataTable().row($(tr))).remove();
                        //	row.remove();
                        //	$('#problemTable').DataTable().draw("full-hold");
                    }
                });
            });

            $("#problemTable").on("click", ".tagBtn", function(e) {
                var id = $(e.target).attr("id").replace("tag", "");
                var items = $("#tag" + id).parent().parent().parent().find("td");
                var tags = $(items.get(columns.TAGS)).text().replace(/\s*\(x\)\s*/g, ",").replace(/.$/, "");
                $("#tags").val(tags);
                $('#tagWindow').find('input#submit').off().on("click", function(e) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    var obj = {
                        "tags": $("#tags").val(),
                        "id": id
                    };
                    $.ajax({
                        type: "post",
                        data: obj,
                        cache: false,
                        url: "updateTags",
                        dataType: "text",
                        error: function(xhr, status, error) {
                            console.log(xhr.responseText);
                        },
                        success: function(tags) {
                            $(items.get(columns.TAGS)).html(tags);
                            $("#tags").val("");
                            $(".popup-modal-dismiss").click();
                        }
                    });

                });
                wb.doc.trigger("open.wb-lbx", [
                    [{
                        src: "#tagWindow",
                        type: "inline"
                    }]
                ]);

            });

            $("#problemTable").on("click", ".tagDeleteBtn", function(e) {
                var id = $(e.target).attr("id").replace("tagDelete", "");
                var tag = $(e.target).text().replace(/\s*\(x\)\s*/g, "");
                var obj = {
                    "tag": tag,
                    "id": id
                };
                $.ajax({
                    type: "post",
                    data: obj,
                    cache: false,
                    url: "deleteTag",
                    dataType: "text",
                    error: function(xhr, status, error) {
                        console.log(xhr.responseText);
                    },
                    success: function(tags) {
                        $(e.target).remove();
                    }
                });
            });


        });
    </script>
</th:block>


</html>