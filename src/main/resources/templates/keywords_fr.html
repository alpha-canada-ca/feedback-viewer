<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{wide_fr}" lang="fr">

<head>
	<link
		href="https://cdn.datatables.net/v/dt/jq-3.7.0/jszip-3.10.1/dt-2.3.2/b-3.2.0/b-html5-3.2.0/cr-2.0.4/fh-4.0.1/r-3.0.3/datatables.min.css"
		rel="stylesheet" type="text/css" />
	<link rel="stylesheet" type="text/css" href="/css/keywords_styles.css" />
</head>

<th:block layout:fragment="content">
	<style>
		.keyword-header {
			margin-bottom: 30px;
		}

		.keyword-stats {
			background: #f5f5f5;
			padding: 15px;
			border-radius: 4px;
			margin-bottom: 20px;
		}

		.stat-box {
			text-align: center;
		}

		.stat-number {
			font-size: 24px;
			font-weight: bold;
			color: #2572b4;
		}

		.stat-label {
			font-size: 12px;
			color: #666;
			text-transform: uppercase;
		}

		.filter-section {
			background: #fff;
			padding: 20px;
			border: 1px solid #ddd;
			border-radius: 4px;
			margin-bottom: 20px;
		}

		.filter-section h3 {
			margin-top: 0;
			font-size: 16px;
		}

		.action-buttons {
			margin-bottom: 20px;
		}

		.action-buttons .btn {
			margin-right: 10px;
		}

		.badge {
			padding: 4px 8px;
			border-radius: 3px;
			font-size: 11px;
			font-weight: 600;
		}

		.badge-profanity {
			background: #d9534f;
			color: white;
		}

		.badge-threat {
			background: #f0ad4e;
			color: white;
		}

		.badge-allowed {
			background: #5cb85c;
			color: white;
		}

		.badge-error {
			background: #5bc0de;
			color: white;
		}

		.badge-active {
			background: #5cb85c;
			color: white;
		}

		.badge-inactive {
			background: #999;
			color: white;
		}

		.modal-overlay {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.6);
		}

		.modal-content {
			background-color: white;
			margin: 5% auto;
			padding: 0;
			border-radius: 6px;
			width: 90%;
			max-width: 500px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
		}

		.modal-header {
			padding: 20px;
			border-bottom: 1px solid #e5e5e5;
		}

		.modal-header h2 {
			margin: 0;
			font-size: 20px;
		}

		.modal-body {
			padding: 20px;
		}

		.modal-footer {
			padding: 15px 20px;
			border-top: 1px solid #e5e5e5;
			text-align: right;
		}

		.alert {
			padding: 12px;
			border-radius: 4px;
			margin-bottom: 15px;
		}

		.alert-danger {
			background: #f2dede;
			border: 1px solid #ebccd1;
			color: #a94442;
		}

		.alert-success {
			background: #dff0d8;
			border: 1px solid #d6e9c6;
			color: #3c763d;
		}

		.btn-action {
			margin-right: 5px;
		}

		.table>tbody>tr>td {
			vertical-align: middle;
		}
	</style>

	<div class="container">
		<div class="row">
			<div class="col-md-12">
				<div class="keyword-header">
					<h1>Gestion des mots-clés</h1>
					<p class="lead">Gérer les mots-clés de filtrage de contenu, y compris les mots vulgaires, les
						menaces, les mots autorisés et les mots-clés d'erreur.</p>
				</div>

				<!-- Quick Filters -->
				<div class="filter-section">
					<h3>Filtres rapides</h3>
					<div class="row">
						<div class="col-sm-3">
							<label for="filterType">Type :</label>
							<select id="filterType" class="form-control input-sm">
								<option value="">Tous les types</option>
								<option value="profanity">Vulgaire</option>
								<option value="threat">Menace</option>
								<option value="allowed">Autorisé</option>
								<option value="error">Erreur</option>
							</select>
						</div>
						<div class="col-sm-3">
							<label for="filterLanguage">Langue :</label>
							<select id="filterLanguage" class="form-control input-sm">
								<option value="">Toutes les langues</option>
								<option value="en">Anglais</option>
								<option value="fr">Français</option>
								<option value="both">Les deux</option>
							</select>
						</div>
						<div class="col-sm-3">
							<label for="filterStatus">Statut :</label>
							<select id="filterStatus" class="form-control input-sm">
								<option value="">Tous les statuts</option>
								<option value="active">Actif</option>
								<option value="inactive">Inactif</option>
							</select>
						</div>
						<div class="col-sm-3">
							<label>&nbsp;</label>
							<button id="clearFilters" class="btn btn-default btn-sm btn-block">Effacer les
								filtres</button>
						</div>
					</div>
				</div>

				<!-- Action buttons -->
				<div class="action-buttons">
					<button id="addNewBtn" class="btn btn-primary">
						<span class="glyphicon glyphicon-plus"></span> Ajouter un nouveau mot-clé
					</button>
					<button id="exportBtn" class="btn btn-success">
						<span class="glyphicon glyphicon-download-alt"></span> Exporter en CSV
					</button>
				</div>

				<!-- Add/Edit modal -->
				<div id="editModal" class="modal-overlay">
					<div class="modal-content">
						<div class="modal-header">
							<h2 id="modalTitle">Ajouter un nouveau mot-clé</h2>
						</div>
						<form id="editForm">
							<div class="modal-body">
								<input type="hidden" id="editId" value="">

								<div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
								<div id="successMessage" class="alert alert-success" style="display: none;"></div>

								<div class="form-group">
									<label for="editWord">Mot : <span style="color: red;">*</span></label>
									<input type="text" class="form-control" id="editWord"
										placeholder="Entrez le mot-clé" required autofocus>
									<small class="help-block">Le mot sera automatiquement converti en
										minuscules.</small>
								</div>

								<div class="row">
									<div class="col-sm-6">
										<div class="form-group">
											<label for="editLanguage">Langue : <span
													style="color: red;">*</span></label>
											<select class="form-control" id="editLanguage" required>
												<option value="en">Anglais</option>
												<option value="fr">Français</option>
												<option value="both">Les deux langues</option>
											</select>
										</div>
									</div>
									<div class="col-sm-6">
										<div class="form-group">
											<label for="editType">Type : <span style="color: red;">*</span></label>
											<select class="form-control" id="editType" required>
												<option value="profanity">Vulgaire</option>
												<option value="threat">Menace</option>
												<option value="allowed">Autorisé</option>
												<option value="error">Erreur</option>
											</select>
										</div>
									</div>
								</div>

								<div class="checkbox">
									<label>
										<input type="checkbox" id="editActive" checked> <strong>Actif</strong>
										<small class="help-block" style="margin-left: 20px;">Les mots-clés inactifs ne
											seront pas utilisés pour le filtrage</small>
									</label>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" id="cancelBtn" class="btn btn-default">Annuler</button>
								<button type="submit" class="btn btn-primary">Enregistrer le mot-clé</button>
							</div>
						</form>
					</div>
				</div>

				<!-- Keywords table with scrollable body -->
				<div class="keywords-table-wrapper">
					<div class="table-scroll-container">
						<table id="keywordsTable" class="table table-striped table-hover">
							<thead>
								<tr>
									<th style="width: 30%;">Mot</th>
									<th style="width: 15%;">Langue</th>
									<th style="width: 15%;">Type</th>
									<th style="width: 15%;">Statut</th>
									<th style="width: 25%;">Actions</th>
								</tr>
							</thead>
							<tbody>
								<tr th:remove="tag" th:utext="${data}"></tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</th:block>

<th:block layout:fragment="script">
	<script
		src="https://cdn.datatables.net/v/dt/jq-3.7.0/jszip-3.10.1/dt-2.3.2/b-3.2.0/b-html5-3.2.0/cr-2.0.4/fh-4.0.1/r-3.0.3/datatables.min.js"></script>
	<script th:inline="javascript">
		$(document).ready(function () {
			// Initialize DataTable with proper configuration
			var table = new DataTable('#keywordsTable', {
				pageLength: 25,
				lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tous"]],
				order: [[0, 'asc']],
				language: {
					search: "Rechercher:",
					lengthMenu: "Afficher _MENU_ entrées",
					info: "Affichage de _START_ à _END_ sur _TOTAL_ mots-clés",
					infoEmpty: "Aucun mot-clé à afficher",
					infoFiltered: "(filtré sur _MAX_ mots-clés au total)",
					paginate: {
						first: "Premier",
						last: "Dernier",
						next: "Suivant",
						previous: "Précédent"
					}
				},
				dom: 't<"table-controls-outside"lip>',
				paging: true,
				responsive: false
			});

			// Move controls outside the table wrapper after DataTables initializes
			$('.table-controls-outside').insertAfter('.keywords-table-wrapper');

			// Filter functionality
			$("#filterType, #filterLanguage, #filterStatus").on("change", function () {
				applyFilters();
			});

			$("#clearFilters").on("click", function () {
				$("#filterType").val("");
				$("#filterLanguage").val("");
				$("#filterStatus").val("");
				applyFilters();
			});

			function applyFilters() {
				var typeFilter = $("#filterType").val();
				var langFilter = $("#filterLanguage").val();
				var statusFilter = $("#filterStatus").val();

				table.columns(1).search(langFilter).draw();
				table.columns(2).search(typeFilter).draw();
				table.columns(3).search(statusFilter).draw();
			}

			// Add new keyword button
			$("#addNewBtn").on("click", function () {
				$("#modalTitle").text("Ajouter un nouveau mot-clé");
				$("#editId").val("");
				$("#editWord").val("");
				$("#editLanguage").val("en");
				$("#editType").val("profanity");
				$("#editActive").prop("checked", true);
				$("#errorMessage").hide();
				$("#successMessage").hide();
				$("#editModal").fadeIn(200);
				setTimeout(function () { $("#editWord").focus(); }, 250);
			});

			// Cancel button
			$("#cancelBtn").on("click", function () {
				$("#editModal").fadeOut(200);
			});

			// Close modal when clicking outside
			$("#editModal").on("click", function (e) {
				if (e.target.id === "editModal") {
					$("#editModal").fadeOut(200);
				}
			});

			// ESC key closes modal
			$(document).on("keyup", function (e) {
				if (e.key === "Escape" && $("#editModal").is(":visible")) {
					$("#editModal").fadeOut(200);
				}
			});

			// Edit button
			$("body").on("click", ".editBtn", function (e) {
				var btn = $(e.target).closest("button");
				$("#modalTitle").text("Modifier le mot-clé");
				$("#editId").val(btn.data("id"));
				$("#editWord").val(btn.data("word"));
				$("#editLanguage").val(btn.data("language"));
				$("#editType").val(btn.data("type"));
				$("#editActive").prop("checked", btn.data("active"));
				$("#errorMessage").hide();
				$("#successMessage").hide();
				$("#editModal").fadeIn(200);
				setTimeout(function () { $("#editWord").focus(); }, 250);
			});

			// Form submission
			$("#editForm").on("submit", function (e) {
				e.preventDefault();
				$("#errorMessage").hide();
				$("#successMessage").hide();

				var submitBtn = $(this).find("button[type=submit]");
				var originalText = submitBtn.html();
				submitBtn.prop("disabled", true).html("Enregistrement..."); var id = $("#editId").val();
				var url = id ? "/keywords/update" : "/keywords/create";
				var data = {
					word: $("#editWord").val(),
					language: $("#editLanguage").val(),
					type: $("#editType").val(),
					active: $("#editActive").is(":checked")
				};

				if (id) {
					data.id = id;
				}

				$.ajax({
					type: "get",
					data: data,
					cache: false,
					url: url,
					dataType: "text",
					error: function (xhr, status, error) {
						submitBtn.prop("disabled", false).html(originalText);
						$("#errorMessage").html("<strong>Erreur :</strong> " + xhr.responseText).show();
					},
					success: function (response) {
						submitBtn.prop("disabled", false).html(originalText);
						if (response.startsWith("Error")) {
							$("#errorMessage").html("<strong>Erreur :</strong> " + response.replace("Error: ", "")).show();
						} else {
							$("#successMessage").html("<strong>Succès !</strong> Mot-clé enregistré. Rechargement...").show();
							setTimeout(function () {
								location.reload();
							}, 1000);
						}
					}
				});
			});

			// Delete button with better confirmation
			$("body").on("click", ".deleteBtn", function (e) {
				var btn = $(e.target).closest("button");
				var word = btn.closest("tr").find("td:first strong").text();

				if (!confirm("Êtes-vous sûr de vouloir supprimer le mot-clé '" + word + "' ?\n\nCette action ne peut pas être annulée.")) {
					return;
				}

				btn.prop("disabled", true).html("<span class='glyphicon glyphicon-refresh spinning'></span>");

				var id = btn.attr("id").replace("delete", "");
				$.ajax({
					type: "get",
					data: { "id": id },
					cache: false,
					url: "/keywords/delete",
					dataType: "text",
					error: function (xhr, status, error) {
						btn.prop("disabled", false).html("Supprimer");
						alert("Erreur lors de la suppression du mot-clé : " + xhr.responseText);
					},
					success: function (response) {
						if (response.startsWith("Error")) {
							btn.prop("disabled", false).html("Supprimer");
							alert(response);
						} else {
							btn.closest("tr").fadeOut(300, function () {
								$(this).remove();
							});
						}
					}
				});
			});

			// Activate button
			$("body").on("click", ".activateBtn", function (e) {
				var btn = $(e.target).closest("button");
				btn.prop("disabled", true).html("Activation..."); var id = btn.attr("id").replace("activate", "");
				$.ajax({
					type: "get",
					data: {
						"id": id,
						"active": true
					},
					cache: false,
					url: "/keywords/update",
					dataType: "text",
					error: function (xhr, status, error) {
						btn.prop("disabled", false).html("Activer");
						alert("Erreur lors de l'activation du mot-clé : " + xhr.responseText);
					},
					success: function (response) {
						if (response.startsWith("Error")) {
							btn.prop("disabled", false).html("Activer");
							alert(response);
						} else {
							var row = btn.closest("tr");
							row.find("td:eq(3)").html("<span class='badge badge-active'>ACTIF</span>");
							btn.replaceWith("<button id='deactivate" + id
								+ "' class='btn btn-warning btn-xs btn-action deactivateBtn' title='Désactiver le mot-clé'>"
								+ "Désactiver</button>");
						}
					}
				});
			});

			// Deactivate button
			$("body").on("click", ".deactivateBtn", function (e) {
				var btn = $(e.target).closest("button");
				btn.prop("disabled", true).html("Désactivation..."); var id = btn.attr("id").replace("deactivate", "");
				$.ajax({
					type: "get",
					data: {
						"id": id,
						"active": false
					},
					cache: false,
					url: "/keywords/update",
					dataType: "text",
					error: function (xhr, status, error) {
						btn.prop("disabled", false).html("Désactiver");
						alert("Erreur lors de la désactivation du mot-clé : " + xhr.responseText);
					},
					success: function (response) {
						if (response.startsWith("Error")) {
							btn.prop("disabled", false).html("Désactiver");
							alert(response);
						} else {
							var row = btn.closest("tr");
							row.find("td:eq(3)").html("<span class='badge badge-inactive'>INACTIF</span>");
							btn.replaceWith("<button id='activate" + id
								+ "' class='btn btn-success btn-xs btn-action activateBtn' title='Activer le mot-clé'>"
								+ "Activer</button>");
						}
					}
				});
			});

			// Export button
			$("#exportBtn").on("click", function () {
				window.location.href = "/keywords/export";
			});
		});
	</script>
</th:block>

</html>